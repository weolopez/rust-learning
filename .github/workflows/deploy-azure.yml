name: Deploy to Azure Container Instances

on:
  push:
    branches: [main]
    paths:
      - 'rust-simple-rest-api/**'
      - 'rust-static-web-server/**'
      - '.github/workflows/deploy-azure.yml'
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'Deploy API container'
        type: boolean
        default: true
      deploy_web:
        description: 'Deploy Web container'
        type: boolean
        default: true

env:
  AZURE_RG: rg-rust-app
  ACR_NAME: acrrustapp
  ACR_LOGIN_SERVER: acrrustapp.azurecr.io
  API_CONTAINER: api-container
  WEB_CONTAINER: web-container
  API_DNS: rust-api-demo
  WEB_DNS: rust-web-demo

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      api_image: ${{ steps.build-api.outputs.image }}
      web_image: ${{ steps.build-web.outputs.image }}
      api_fqdn: ${{ steps.deploy-api.outputs.fqdn }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Build and push API image
        id: build-api
        if: ${{ github.event.inputs.deploy_api != 'false' }}
        run: |
          IMAGE="${{ env.ACR_LOGIN_SERVER }}/rust-simple-rest-api:${{ github.sha }}"
          docker build --platform linux/amd64 \
            -f rust-simple-rest-api/Dockerfile \
            -t $IMAGE \
            -t ${{ env.ACR_LOGIN_SERVER }}/rust-simple-rest-api:latest \
            .
          docker push $IMAGE
          docker push ${{ env.ACR_LOGIN_SERVER }}/rust-simple-rest-api:latest
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Deploy API to ACI
        id: deploy-api
        if: ${{ github.event.inputs.deploy_api != 'false' }}
        run: |
          # Delete existing container if it exists
          az container delete \
            --resource-group ${{ env.AZURE_RG }} \
            --name ${{ env.API_CONTAINER }} \
            --yes || true
          
          # Get ACR credentials
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          # Create new container
          az container create \
            --resource-group ${{ env.AZURE_RG }} \
            --name ${{ env.API_CONTAINER }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/rust-simple-rest-api:${{ github.sha }} \
            --dns-name-label ${{ env.API_DNS }} \
            --ports 3000 \
            --os-type Linux \
            --cpu 1 \
            --memory 1 \
            --environment-variables \
              GEMINI_API_KEY="${{ secrets.GEMINI_API_KEY }}" \
              RUST_LOG="info" \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_NAME }} \
            --registry-password "$ACR_PASSWORD" \
            --restart-policy OnFailure
          
          # Get FQDN
          FQDN=$(az container show \
            --resource-group ${{ env.AZURE_RG }} \
            --name ${{ env.API_CONTAINER }} \
            --query ipAddress.fqdn -o tsv)
          echo "fqdn=$FQDN" >> $GITHUB_OUTPUT
          echo "API deployed at: http://$FQDN:3000"

      - name: Update frontend config
        if: ${{ github.event.inputs.deploy_web != 'false' }}
        run: |
          API_FQDN="${{ steps.deploy-api.outputs.fqdn }}"
          if [ -z "$API_FQDN" ]; then
            # If API wasn't deployed this run, get existing FQDN
            API_FQDN=$(az container show \
              --resource-group ${{ env.AZURE_RG }} \
              --name ${{ env.API_CONTAINER }} \
              --query ipAddress.fqdn -o tsv)
          fi
          cat > rust-static-web-server/static/config.js <<EOF
          // Production configuration - auto-generated by CI/CD
          const API_URL = "http://${API_FQDN}:3000";
          EOF
          cat rust-static-web-server/static/config.js

      - name: Build and push Web image
        id: build-web
        if: ${{ github.event.inputs.deploy_web != 'false' }}
        run: |
          IMAGE="${{ env.ACR_LOGIN_SERVER }}/rust-static-web-server:${{ github.sha }}"
          docker build --platform linux/amd64 \
            -f rust-static-web-server/Dockerfile \
            -t $IMAGE \
            -t ${{ env.ACR_LOGIN_SERVER }}/rust-static-web-server:latest \
            .
          docker push $IMAGE
          docker push ${{ env.ACR_LOGIN_SERVER }}/rust-static-web-server:latest
          echo "image=$IMAGE" >> $GITHUB_OUTPUT

      - name: Deploy Web to ACI
        if: ${{ github.event.inputs.deploy_web != 'false' }}
        run: |
          # Delete existing container if it exists
          az container delete \
            --resource-group ${{ env.AZURE_RG }} \
            --name ${{ env.WEB_CONTAINER }} \
            --yes || true
          
          # Get ACR credentials
          ACR_PASSWORD=$(az acr credential show --name ${{ env.ACR_NAME }} --query "passwords[0].value" -o tsv)
          
          # Create new container
          az container create \
            --resource-group ${{ env.AZURE_RG }} \
            --name ${{ env.WEB_CONTAINER }} \
            --image ${{ env.ACR_LOGIN_SERVER }}/rust-static-web-server:${{ github.sha }} \
            --dns-name-label ${{ env.WEB_DNS }} \
            --ports 8080 \
            --os-type Linux \
            --cpu 1 \
            --memory 1 \
            --environment-variables RUST_LOG="info" \
            --registry-login-server ${{ env.ACR_LOGIN_SERVER }} \
            --registry-username ${{ env.ACR_NAME }} \
            --registry-password "$ACR_PASSWORD" \
            --restart-policy OnFailure
          
          # Get FQDN
          WEB_FQDN=$(az container show \
            --resource-group ${{ env.AZURE_RG }} \
            --name ${{ env.WEB_CONTAINER }} \
            --query ipAddress.fqdn -o tsv)
          echo "Web deployed at: http://$WEB_FQDN:8080"

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          API_FQDN=$(az container show --resource-group ${{ env.AZURE_RG }} --name ${{ env.API_CONTAINER }} --query ipAddress.fqdn -o tsv 2>/dev/null || echo "N/A")
          WEB_FQDN=$(az container show --resource-group ${{ env.AZURE_RG }} --name ${{ env.WEB_CONTAINER }} --query ipAddress.fqdn -o tsv 2>/dev/null || echo "N/A")
          echo "| Service | URL |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| API | http://$API_FQDN:3000 |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | http://$WEB_FQDN:8080 |" >> $GITHUB_STEP_SUMMARY

  test:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Wait for containers to be ready
        run: sleep 30

      - name: Test API endpoint
        run: |
          API_FQDN="${{ needs.build-and-push.outputs.api_fqdn }}"
          if [ -z "$API_FQDN" ]; then
            echo "API FQDN not available, skipping test"
            exit 0
          fi
          echo "Testing API at http://$API_FQDN:3000/items"
          curl -f --max-time 30 "http://$API_FQDN:3000/items" || exit 1
          echo "API test passed!"
